name: CD - Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION }}
  REGISTRY: ${{ vars.GCP_REGION }}-docker.pkg.dev
  REPOSITORY: ${{ vars.ARTIFACT_REGISTRY_REPO }}

jobs:
  build-and-deploy-backend:
    name: Build & Deploy Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      # Save current revision for potential rollback
      - name: Get current backend revision
        id: current-revision
        run: |
          CURRENT=$(gcloud run revisions list --service=backend \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(name)" \
            --sort-by="~creationTimestamp" \
            --limit=1 2>/dev/null || echo "")
          echo "revision=$CURRENT" >> $GITHUB_OUTPUT
          if [ -n "$CURRENT" ]; then
            echo "ðŸ“Œ Current backend revision: $CURRENT (saved for rollback)"
          else
            echo "ðŸ“Œ No existing backend revision (first deployment)"
          fi

      - name: Build and push backend image
        id: build-backend
        run: |
          set -e  # Fail fast on any error
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/backend:${{ github.sha }}"
          echo "::group::Building backend image"
          echo "Building image: $IMAGE_TAG"
          docker build --platform linux/amd64 -t $IMAGE_TAG ./backend
          echo "::endgroup::"
          echo "::group::Pushing backend image"
          docker push $IMAGE_TAG
          echo "::endgroup::"
          echo "âœ… Backend image built and pushed successfully"
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # Backend uses --ingress=internal to block direct internet access.
      # Only services with VPC Direct Egress (like frontend) can reach it.
      # Security: internal ingress + CORS (only frontend URL) + separate service accounts.
      - name: Deploy backend to Cloud Run
        id: deploy-backend
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: backend
          region: ${{ env.REGION }}
          image: ${{ steps.build-backend.outputs.image }}
          secrets: |
            ANTHROPIC_API_KEY=anthropic-api-key:latest
          flags: |
            --port=8080
            --memory=1Gi
            --cpu=1
            --min-instances=0
            --max-instances=10
            --timeout=300
            --ingress=internal
            --allow-unauthenticated
            --service-account=backend-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com

      # Grant frontend service account permission to invoke backend
      - name: Grant frontend invoke permission on backend
        run: |
          echo "ðŸ”‘ Granting frontend-sa permission to invoke backend..."
          gcloud run services add-iam-policy-binding backend \
            --region=${{ env.REGION }} \
            --member="serviceAccount:frontend-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com" \
            --role="roles/run.invoker" \
            --project=${{ env.PROJECT_ID }} \
            --quiet
          echo "âœ… Frontend can now invoke backend via IAM"

      # Note: Backend has --ingress=internal, so we cannot health check it directly from GitHub Actions.
      # Backend health is verified via frontend proxy after frontend deploys (see end-to-end check below).
      # Cloud Run also performs its own container startup probe.
      - name: Backend deployed (health check via frontend)
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "ðŸ“ Note: Backend has internal ingress - health check will run via frontend proxy"
          echo "ðŸ”— Backend URL (internal): ${{ steps.deploy-backend.outputs.url }}"

      # Automatic rollback on health check failure
      - name: Rollback backend on failure
        if: failure() && steps.current-revision.outputs.revision != ''
        run: |
          echo "ðŸ”„ Rolling back backend to previous revision: ${{ steps.current-revision.outputs.revision }}"
          gcloud run services update-traffic backend \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --to-revisions=${{ steps.current-revision.outputs.revision }}=100
          echo "âœ… Rollback complete! Traffic restored to previous revision."
          echo "âš ï¸  Please investigate the failed deployment before retrying."

      - name: Show backend URL
        run: |
          echo "âœ… Backend deployed successfully!"
          echo "URL: ${{ steps.deploy-backend.outputs.url }}"
          echo "API Docs: ${{ steps.deploy-backend.outputs.url }}/docs"

    outputs:
      backend_url: ${{ steps.deploy-backend.outputs.url }}

  build-and-deploy-frontend:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: build-and-deploy-backend
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      # Enable Private Google Access for VPC Direct Egress to work
      - name: Enable Private Google Access
        run: |
          echo "ðŸŒ Enabling Private Google Access on default subnet..."
          gcloud compute networks subnets update default \
            --region=${{ env.REGION }} \
            --enable-private-ip-google-access \
            --project=${{ env.PROJECT_ID }} \
            --quiet 2>/dev/null || echo "Already enabled or no permission"
          echo "âœ… Private Google Access enabled"

      # Save current revision for potential rollback
      - name: Get current frontend revision
        id: current-revision
        run: |
          CURRENT=$(gcloud run revisions list --service=frontend \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(name)" \
            --sort-by="~creationTimestamp" \
            --limit=1 2>/dev/null || echo "")
          echo "revision=$CURRENT" >> $GITHUB_OUTPUT
          if [ -n "$CURRENT" ]; then
            echo "ðŸ“Œ Current frontend revision: $CURRENT (saved for rollback)"
          else
            echo "ðŸ“Œ No existing frontend revision (first deployment)"
          fi

      - name: Build and push frontend image
        id: build-frontend
        run: |
          set -e  # Fail fast on any error
          IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }}"
          echo "::group::Building frontend image"
          echo "Building image: $IMAGE_TAG"
          # Frontend uses /api proxy to reach backend (see nginx config)
          docker build \
            --platform linux/amd64 \
            -t $IMAGE_TAG \
            ./frontend
          echo "::endgroup::"
          echo "::group::Pushing frontend image"
          docker push $IMAGE_TAG
          echo "::endgroup::"
          echo "âœ… Frontend image built and pushed successfully"
          echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # Frontend uses VPC Direct Egress to reach internal backend.
      # --network/--subnet/--vpc-egress enable traffic to flow through VPC.
      - name: Deploy frontend to Cloud Run
        id: deploy-frontend
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: frontend
          region: ${{ env.REGION }}
          image: ${{ steps.build-frontend.outputs.image }}
          env_vars: |
            BACKEND_URL=${{ needs.build-and-deploy-backend.outputs.backend_url }}
          flags: |
            --port=8080
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=5
            --timeout=60
            --allow-unauthenticated
            --service-account=frontend-sa@${{ env.PROJECT_ID }}.iam.gserviceaccount.com
            --network=default
            --subnet=default
            --vpc-egress=all-traffic

      - name: Verify frontend health
        id: health-check
        run: |
          set -e
          FRONTEND_URL="${{ steps.deploy-frontend.outputs.url }}"
          echo "ðŸ¥ Verifying frontend health at $FRONTEND_URL/health"
          for i in {1..5}; do
            if curl -sf "$FRONTEND_URL/health" > /dev/null 2>&1; then
              echo "âœ… Frontend is healthy!"
              echo "health_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "â³ Attempt $i/5 - waiting for frontend..."
            sleep 10
          done
          echo "âŒ Frontend health check failed!"
          echo "health_status=failed" >> $GITHUB_OUTPUT
          exit 1

      # Automatic rollback on health check failure
      - name: Rollback frontend on failure
        if: failure() && steps.current-revision.outputs.revision != ''
        run: |
          echo "ðŸ”„ Rolling back frontend to previous revision: ${{ steps.current-revision.outputs.revision }}"
          gcloud run services update-traffic frontend \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --to-revisions=${{ steps.current-revision.outputs.revision }}=100
          echo "âœ… Rollback complete! Traffic restored to previous revision."
          echo "âš ï¸  Please investigate the failed deployment before retrying."

      - name: Show frontend URL
        run: |
          echo "âœ… Frontend deployed successfully!"
          echo "URL: ${{ steps.deploy-frontend.outputs.url }}"

      # End-to-end health check: verify backend is reachable via frontend proxy
      - name: Verify backend via frontend proxy (end-to-end)
        run: |
          set -e
          FRONTEND_URL="${{ steps.deploy-frontend.outputs.url }}"
          echo "ðŸ¥ Verifying backend health via frontend proxy at $FRONTEND_URL/api/health"

          for i in {1..5}; do
            RESPONSE=$(curl -sf "$FRONTEND_URL/api/health" 2>/dev/null || echo "")
            if [ -n "$RESPONSE" ]; then
              echo "âœ… End-to-end check passed! Backend is healthy via frontend proxy"
              echo "$RESPONSE" | jq . 2>/dev/null || echo "$RESPONSE"
              exit 0
            fi
            echo "â³ Attempt $i/5 - waiting for backend via proxy..."
            sleep 10
          done
          echo "âŒ End-to-end health check failed! Backend unreachable via frontend proxy"
          exit 1

      - name: Update backend CORS with frontend URL
        run: |
          echo "Updating backend ALLOWED_ORIGINS to ${{ steps.deploy-frontend.outputs.url }}"
          # Get ID token for authenticated request to backend
          TOKEN=$(gcloud auth print-identity-token --audiences=${{ needs.build-and-deploy-backend.outputs.backend_url }} 2>/dev/null || echo "")
          gcloud run services update backend \
            --region=${{ env.REGION }} \
            --update-env-vars="ALLOWED_ORIGINS=${{ steps.deploy-frontend.outputs.url }}" \
            --project=${{ env.PROJECT_ID }} \
            --quiet

    outputs:
      frontend_url: ${{ steps.deploy-frontend.outputs.url }}

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [build-and-deploy-backend, build-and-deploy-frontend]
    steps:
      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.build-and-deploy-frontend.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.build-and-deploy-backend.outputs.backend_url }} (internal) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: Internal ingress only (not accessible from internet)" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: Public access with VPC Direct Egress to reach backend" >> $GITHUB_STEP_SUMMARY
          echo "- **VPC**: Private Google Access enabled for VPC-to-Cloud-Run traffic" >> $GITHUB_STEP_SUMMARY
          echo "- **IAM**: Frontend SA has \`roles/run.invoker\` on backend" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Rollback" >> $GITHUB_STEP_SUMMARY
          echo "Automatic rollback is enabled. If health checks fail, traffic is restored to the previous revision." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
